# 도메인 분석 설계

**다대다 관계 해결**

- 한 번 주문 할때 여러 상품 선택 가능 ⇒ 다대다 관계 형성
- 하지만 다대다 관계는 관계형 데이터베이스와 엔티티에서 사용하지 않는다.
- 이를 위해 주문상품 엔티티를 추가 해서 다대다 관계를 일대다, 다대일 관계로 구성한다.

<br>

**연관관계 주인**

- FK가 있는곳이 항상 다가 되며 동시에 연관관계 주인이 된다.
- 연관관계 주인만이 왜래 키를 관리(등록, 수정) 가능, 나머지는 조회만
- 연관관계 주인은 단순히 외래키를 누가 관리하냐의 문제
- 비즈니스상 우위에 있다고 해서 주인으로 정하면 안된다.
- 주인은 mappedBy 속성 사용 X
- 주인이 아니면 mappedBy 속성으로 주인 지정

<br>

**Setter**

- 가급적이면 Getter는 열어두고  Setter는 필요한 경우에만 사용
- Getter는 호출하는 것만으로 어떠한 일이 발생하지 않는다.
- Setter가 모두 열려있으면 변경포인트가 너무 많아 유지보수가 어렵다.
- 엔티티를 변경할때는 Setter대신 변경 지점이 명확하도록 비즈니스 메소드를 별도로 제공해야 한다.

<br>

**상속관계 매핑**

- @Inheritance(strategy=InheritanceType.XXX)
    - JOINDE : 조인 전략
    - SINGLE_TABLE : 단일 테이블 전략
    - TABLE_PER_CLASS : 구현 클래스마다 테이블 전략
- @DiscriminatorColumn(name=”DTYPE”)
- @DiscriminatorValue(”XXX”) - 데이터 타입 구분하기 위해 사용

<br>

**Enum** 

- Enum 사용 시 @Enumerated 어노테이션 사용
    - EnumType.ORDINAL: enum 순서를 데이터베이스에 저장
    - EnumType.STRING: enum 이름을 데이터베이스에 저장
    - ORDINAL 사용 시 enum에 추가항목이 생길 경우 문제를 발생 시킬 수 있음 꼭 STRING 으로 사용!

<br>

**값 타입**

- setter를 제공 X, 생성자에서 값을 모두 초기화해서 변경 불가능한 클래스로 생성
- 자바 기본생성자를 public이나 protected로 설정해야 한다.
- JPA가 이런 제약을 두는 이유는 JPA 구현 라이브러리가 객체를 생성할 때 리플랙션 같은 기술을 사용할 수 있도록 지원해야 하기 때문이다.

<br>

**모든 연관관계는 지연로딩으로 설정 (중요)**

- 즉시로딩은 예측이 어렵고, 어떤 SQL이 실행될지 추적하기 어렵다.
- 특히 JPQL을 실핼할 때 N+1 문제가 발생한다.
- 실무에서 모든 연관관계는 지연로딩으로 설정해야 한다.
- 연관된 엔티티를 함께 DB에서 조회해야 하면, fetch join또는 엔티티 그래프 기능을 사용한다.
- @XtoOne 관계는 기본이 즉시로딩이므로 지연로딩으로 변경해줘야 한다.
