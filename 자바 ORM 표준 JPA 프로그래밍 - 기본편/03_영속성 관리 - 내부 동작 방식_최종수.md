# 영속성 관리 - 내부 동작 방식

## 영속성 컨테스트

### 엔티티 매니저 팩토리와 엔티티 매니저

- 고객의 요청 → 팩토리가 매니저를 요청 마다 생성

### 영속성 컨텍스트

- JPA를 이해하는데 가장 중요한 용어
- “엔티티를 영구 저장하는 환경”이라는 뜻
- **EntityManager.persist(entity);**
- 영속성 컨텍스트는 논리적 개념
- 엔티티매니저를 통해서 접근
- J2SE 환경 → 엔티티 매니저와 영속성 컨텍스트가 1:1
- J2EE, 스프링 프레임워크 같은 컨테이너 환경 → 엔티티 매니저와 영속성 컨텍스트가 N:1 (나중에 스프링 부분 하면서 이해)

### 엔티티의 생명주기

- 비영속(new/transient) : 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태
    - 객체를 생성한 상태, JPA와 전혀 상관 없음
- 영속(managed) : EntityManager.persist 하면 영속성 컨텍스트에 관리 되는 상태
    - EntityManager(추후 em으로 작성)를 호출 한 후 em을 통해 저장한 상태
    - DB에 저장된 상태는 아니다!
- 준영속 (detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
    - em.detach : 영속성 컨텍스트에서 분리, 다시 JPA와 상관 없어짐.
- 삭제(removed) : 삭제된 상태
    - em.remove : 객체 삭제한 상태

### 영속성 컨텍스트의 이점

- 1차 캐시
    - 맵안에 key값(pk, @ID) value(Entity, 객체)
    - 만약 1차 캐시에 찾는 객체가 있다면 1차 캐시에서 조회
    - 없다면, DB에서 조회 후 나온 결과를 1차 캐시에 저장 후 반환
    - 결국 고객의 요청이 종료된다면(한 트랜잭션 안에서만) 사라지기 때문에 엄청 큰 이득은 아니다.
- 동일성(identity) 보장
    - 같은 트랜잭션 안에서는 동일성이 보장된다.
- 트랜잭션을 지원하는 쓰기 지연(transactional write-behind)
    - 쓰기 지연 SQL 저장소
    - 1차 캐시에 저장됨과 동시에 SQL문 생성해서 쓰기 지연 SQL 저장소에 쌓아둔다.
    - commit 되는 순간 쓰기 지연 SQL 저장소에서 flush 되면서 commit 된다.
    - 옵션 : hibernate.jdbc.batch_size
- 변경 감지(Dirty Checking)
    - em.update같은 일이 필요 없다.
    - 스냅샷 : 값을 읽어온 최초의 상태, 1차 캐시에 존재
    - flush() → Entity와 스냅샷 비교 → 다르다면 UPDATE SQL 생성
- 지연 로딩(Lazy Loading)

## 플러시(flush)

- 플러시란? : 영속성 컨텍스트의 변경내용을 데이터베이스에 반영

### 플러시 발생

- 변경 감지
- 수정된 엔티티 쓰기 지연 SQL 저장소에 등록
- 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송

### 영속성 컨텍스트를 플러시 하는 방법

- em.flush() - 직접 호출
    - 커밋 전에 확인이 필요한 경우
- 트랜잭션 커밋 - 자동 호출
- JPQL 쿼리 실행 - 자동 호출
    - 이유 : JPA는 에러를 방지하고자 무조건 호출
- 플러시 모드 옵션 (FlushModeType.~)
    - AUTO : 커밋이나 쿼리를 실행할 때 (기본값)
    - COMMIT : 커밋 할 때만(쓸일 거~~의 없음)

### 플러시는!

- 영속성 컨텍스트를 비우지 않음.
- 변경내용을 데이터베이스에 동기화
- 트랜잭션이라는 작업 단위가 중요 → 커밋 직전젱만 동기화 하면 됨.

## 준영속 상태

### 준영속 상태

- 영속 → 준영속
- 영속 상태의 엔티티가 영속성 컨텍스트에서 분리(detached)
- 영속성 컨텍스트가 제공하는 기능을 사용 못함

### 준영속 상태로 만드는 방법

- em.detach(entity) : 특정 엔티티만 준영속 상태로 전환 → JPA에서 관리하지 않는다.
    - 직접 쓸 일 보다는 동작 방식 이해
- em.clear() : 영속성 컨텍스트를 완전히 초기화
- em.close() : 영속성 컨텍스트를 종료