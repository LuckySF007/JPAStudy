# 엔티티 매핑

## 기본 키 매핑

### 기본 키 매핑 어노테이션

- @ID : 직접 할당
- @GeneratedValue : 자동 생성
    - IDENTITY : 데이터베이스에 위임, MYSQL
        - 기본 키 생성을 데이터베이스에 위임
        - 주로 MySQL, PostgreSQL, SQL Server, DB2에서 사용(MySQL의 AUTO_INCREMENT)
        - 영속성 컨텍스트 에서는 pk값이 존재해야만 관리 가능, but DB에 삽입되어야 pk값이 확인 가능 → jpa입장에서 넣을 방도가 없다.
        - 예외적으로 커밋 한 시점이 아닌, persist 실행 할때 쿼리 문을 DB로 보낸다.
    - SEQUENCE : 데이터베이스 시퀀스 오브젝트 사용, ORACLE
        - @SequenceGeneator 필요
        - name : 식별자 생성기 이름
        - sequenceName : DB에 등록되어 있는 시퀀스 이름
        - initialValue : DDL 생성 시에만 사용됨, 시퀀스 DDL을 생성할 때 처음 1 시작하는 수 지정
        - allocationSize : 시퀀스 한 번 호출에 증가하는 수(성능 최적화에 사용됨. **중요 ! : 기본값이 50이므로 하나씩 증가하도록 설정되어 있으면 반드시 1로 설정**)
            - 최초 1을 사용후 한번 더 호출하여 51까지 자리를 마련해 놓는다.
            - 이후 50번째놈까지 메모리에 미리 올려놓은 id값으로 채워준다.
            - 서버가 여러대여도 문제 없다.
        - catalog, schema
        - 데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 특별한 데이터베이스 오브젝트
        - 주로 오라클에서 사용.
        - Long 사용.(전체로 보면 성능 차이 얼마 안나므로  Long 권장)
        - 영속성컨텍스트에 넣어야 하므로 persist할때 sequence에서 id를 가져온다. → IDENTITY랑 다르게 sequence에서만 가져오고 DB로 삽입을 먼저 하지는 않는다.
    - TABLE : 키 생성용 테이블 사용, 모든 DB에서 사용
        - @TableGenerator 필요
        - 키 생성 전용 테이블을 하나 만들어서 데이터베이스 시퀀스를 흉내
        - 장점 : 모든 DB에 적용 가능
        - 단점 : 성능
        - name : 식별자 생성기 이름
        - table : 키생성 테이블명
        - pkColumnName : 시퀀스 컬럼명
        - valueColumnNa : 시퀀스 값 컬럼명
        - pkColumnValue : 키로 사용할 값 이름
        - initialValue : 초기 값, 마지막으로 생성된 값이 기준이다.
        - allocationSize : 시퀀스 한 번 호출에 증가하는 수 (성능 최적화에 사용, 기본값 50)
        - catalog, schema
        - uniqueConstraints(DDL) : 유니크 제약 조건을 지정할 수 있다.
        - 운영서버에서 사용하기는 부담.
    - AUTO : 방언에 따라 자동 지정, 기본값

### 권장하는 식별자 전략

- 기본 키 제약 조건 : null 아님, 유일, **변하면 안된다.**
- 미래까지 이 조건을 만족하는 자연키는 찾기 어렵다. 대리키(대체키) 사용
- 주민등록번호도 기본 키로 적절 X → 변경시 비용 어마어마
- 권장 : Long형 + 대체키 + 키 생성전략 사용

## 실전 예제 - 1. 요구사항 분석과 기본 매핑

### 요구사항 분석

- 회원은 상품을 주문 할 수 있다.
- 주문 시 여러 종류의 상품을 선택할 수 있다.

### 기능 목록

- 회원
    - 회원 등록
    - 회원 조회
- 상품 기능
    - 상품 등록
    - 상품 수정
    - 상품 조회
- 주문 기능
    - 상품 주문
    - 주문 내역 조회
    - 주문 취소

### 도메인 모델 분석

- 회원과 주문의 관계 : 회원은 여러 번 주문할 수 있다. (일대다)
- 주문과 상품의 관계 : 주문할 때 여러 상품을 선택할 수 있다. 반대로 같은 상품도 여러 번 주문될 수 있다. 주문 상품이라는 모델을 만들어 다대다 관계를 일대다, 다대일 관계로 풀어냄.

### 권장사항

- 제약도 직접 추가하는 걸 권장 → 바로 확인 가능
- 개발자들이 객체를 보고 JPQL 짤때 바로 확인 가능하기 때문이다.
- DBA와 Rule을 잘 맞출것.
- 스프링부트로 하이버네이트를 올릴경우 캐멀케이스를 언더바로 수정해준다.

### 데이터 중심 설계의 문제점

- 지금 방식은 테이블 설계에 맞춘 방식
- 테이블의 외래키를 객체에 그대로 가져옴.
- 객체 그래프 탐색 불가능
- 참조가 없으므로 UML도 잘못됨