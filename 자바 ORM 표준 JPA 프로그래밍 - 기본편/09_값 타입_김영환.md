# JPA 기본 9

## 타입 분류

### 엔티티 타입

- `@Entity`로 정의하는 객체다.
- 데이터가 변해도 식별자로 지속해서 추적 가능하다.

### 값 타입

- int, Integer, String과 같이 단순히 값으로 사용하는 자바 기본 타입이나 객체를 말한다.
- 식별자가 없이 값만 있으므로 변경 시 추적 불가하다.



## 값 타입 분류

- **기본 값 타입**
  - 자바 기본 타입(int, double...)
  - 래퍼 클래스(Integer, Double...)
  - String
- **임베디드 타입**
- **컬렉션 값 타입**



## 기본값 타입

- 생명주기를 엔티티에 의존한다.
  - 예) 회원을 삭제하면 이름, 나이 필드도 함께 삭제된다.
- 값 타입은 공유하면 안된다.
  - 예) 회원 이름 변경 시, 다른 회원의 이름이 함께 변경되서는 아니된다.
  - 래퍼 클래스나 String 클래스는 값의 복사가 아닌 레퍼런스 참조를 끌고 오기에 객체가 공유되니 주의하자.



## 임베디드 타입(복합 값 타입)

- 새로운 값 타입을 직접 정의할 수 있다.
- JPA는 임베디드 타입이라 부른다.
- 주로 기본 값 타입을 모아서 만들기에 복합 값 타입이라고 부르기도 한다.

### 장점

- 재사용성
- 높은 응집도
- 의미 있는 메서드를 정의해 사용할 수 있다.
- 임베디드 타입을 포함한 모든 값 타입은 값 타입을 소유한 엔티티에 생명주기를 의존한다.

### 임베디드 타입 사용법

- `@Embeddable`
  - 값 타입을 정의하는 곳에 표기한다.
- `@Embedded`
  - 값 타입을 사용하는 곳에 표기한다.
- 기본 생성자는 필수다.

### 임베디드 타입과 테이블 매핑

- 임베디드 타입은 엔티티의 값일 뿐이고, 사용 전과 후의 매핑 테이블은 같다.
- 객체와 테이블을 아주 세밀하게 매핑하는 것이 가능하다.
- 잘 설계한 ORM 애플리케이션은 매핑한 테이블의 수보다 클래스의 수가 더 많다.

### 연관관계

- 임베디드 타입이 임베디드 타입을 가질 수 있다.
- 엔티티가 임베디드 타입을 가질 수 있다.
- 임베디드 타입이 엔티티를 가질 수 있다.

### @AttributeOverride (속성 재정의)

- 한 엔티티에서 같은 값 타입 사용시에 사용한다.
- `@AttributeOverrides`, `@AttributeOverride`를 사용해서 컬럼명 속성을 재정의할 수 있다.



## 값 타입과 불변 객체

- 값 타입은 복잡한 객체를 단순히 다루기 위해 만든 개념이다. 즉, 값 타입은 단순하고 안전하게 다룰 수 있어야 한다.

### 값 타입 공유 참조

- 임베디드 타입 같은 값 타입을 여러 엔티티에서 공유 시, 위험하다.
  - side effect 발생!!

### 값 타입 복사

- 값 타입의 실제 인스턴스 값을 공유하는 것은 매우 위험하다.
- 대신 인스턴스를 복사해서 사용하자.

### 객체 타입의 한계

- 항상 값을 복사해서 사용하면 공유 참조로 인해 발생하는 부작용을 피할 수 없다.
- 임베디드 타입과 같이 직접 정의한 값 타입은 객체 타입이다.
  - 객체 타입은 값 대입 시 값을 복사하는 자바 기본 타입과 차이가 있다.
- 객체 타입은 참조 값을 직접 대입하는 것을 막을 방법이 없으니, 객체의 공유 참조를 피할 수 없다.

### 불변 객체

- 객체 타입을 수정할 수 없게 만들어 부작용을 원천 차단한다.
  - 값 타입을 불변(immutable) 객체로 설계한다.
- 생성자로만 값을 설정하고, setter를 만들지 않는다.



## 값 타입의 비교

- **동일성 비교**
  - 인스턴스의 참조 값을 비교한다.
  - `==`을 사용한다.
- **동등성 비교**
  - 인스턴스의 값을 비교한다.
  - `equals()`를 사용한다.
- 값 타입은 `equals()` 메서드를 사용해 동등성 비교를 해야한다.
  - 값 타입의 `equals()` 메서드를 적절히 재정의하여 사용한다.



## 값 타입 컬렉션

### 값 타입 컬렉션이란?

- 값 타입을 하나 이상 저장할 때 사용한다.
- `@ElementCollection`, `@CollectionTable`을 사용한다.
- 데이터베이스는 컬렉션을 같은 테이블에 저장할 수 없다.
- 컬렉션을 저장하기 위한 별도의 테이블이 필요하다.
- 값 타입 컬렉션은 영속성 전이(Cascade)와 고아 객체 제거 기능을 필수로 가진다.
  - 저장, 조회(지연 로딩 전략 사용), 수정

### 값 타입 컬렉션 제약사항

- 값 타입은 엔티티와 다르게 식별자 개념이 없다.
- 값은 변경하면 추적이 어렵다.
- 값 타입 컬렉션에 변경 사항 발생 시, 주인 엔티티와 연관된 모든 데이터를 삭제 후, 현재 값 타입 컬렉션에 남아있는 값을 모두 다시 저장한다.
- 값 타입 컬렉션을 매핑하는 테이블은 모든 컬럼을 묶어서 기본 키를 구성해야 한다.
  - null 입력 안된다.
  - 중복 저장 안된다.

### 값 타입 컬렉션의 대안

- 실무에서는 상황에 따라 **값 타입 컬렉션 대신 일대다 관계를 고려한다.**
- 일대다 관계를 위한 엔티티를 만들고, 여기에서 값 타입을 사용한다.
- 영속성 전이(Cascade)와 고아 객체 제거를 사용해서 값 타입 컬렉션처럼 사용이 가능하다.



## 정리

| 구분      | 엔티티 타입      | 값 타입                                                      |
| --------- | ---------------- | ------------------------------------------------------------ |
| 식별자    | 있음.            | 없음.                                                        |
| 생명주기  | 엔티티가 관리함. | 엔티티에 의존함.                                             |
| 공유 참조 | 공유함.          | 공유하지 않는 것이 안전(복사 후 사용)<br />불변 객체로 만드는 것이 안전함. |

