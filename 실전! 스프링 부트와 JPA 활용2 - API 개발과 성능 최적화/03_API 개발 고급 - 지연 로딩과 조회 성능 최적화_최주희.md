# 03.API 개발 고급 - 지연 로딩과 조회 성능 최적화

## 지연 로딩

- 지연 로딩은 실제 엔티티 대신에 프록시가 존재 → jackson 라이브러리는 이 프록시 객체를 어떻게 json으로 생성해야 할지 모름 → 예외 발생
- Hibernate5Module 빈을 생성하면 해결 가능 → 기본적으로 초기화 된 프록시 객체만 노출, 초기화 되지 않은 프록시 객체는 노출 안함

<br>

## 양방향 연관관계

- 양방향 연관관계가 걸린곳은 양쪽을 서로 호출하면서 무한 루프가 돌 수 있으므로 한 쪽은 @JsonIgnore 을 꼭 붙혀줘야함

<br>

## 지연 로딩 + fetch join 방법

- 아니면 N + 1 문제가 생김
- 위와 같은 방법으로 사용하면 쿼리문 1개로 성능 최적화가 가능
- 무조건 이 방법을 사용하라.

<br>

## JPA에서 DTO로 바로 조회하는 방법

- new 명령어를 이용하여 JPQL의 결과를 DTO로 바로 변환
- select절에서 원하는 데이터만 선택하므로 성능에 약간 더 최적화(하지만 차이가 미비)
- 단점 : 레파지토리 재사용성이 떨어짐 → 반환을 특정 dto로 한정지어놨기 때문 즉, API 내용이 레파지토리에 들어가는 것

<br>

## 쿼리 방식 선택 권장 순서

1) 엔티티를 DTO로 변환

2) 필요하면 패치 조인으로 성능 최적화 → 대부분 성능 문제 해결가능

3) 그래도 안되면 DTO로 직접 조회하는 방법 사용

4) 최후 방법은 JPA가 제공하는 네이티브 sql이나 스프링 JDBC Template으로 직접 sql을 사용한다.